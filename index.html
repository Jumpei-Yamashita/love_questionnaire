<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>話題ランダム表示（拡張版）</title>
<style>
  :root{--bg:#f7f7fb;--card:#fff;--text:#222;--accent:#5b7cfa;--muted:#666;}
  html,body{height:100%}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic","Noto Sans JP",sans-serif;background:var(--bg);color:var(--text);display:grid;place-items:center}
  .wrap{width:min(980px,94vw);background:var(--card);border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:22px 22px 26px}
  h1{margin:0 0 6px;font-size:clamp(20px,3vw,28px)}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 10px}
  .btn{appearance:none;border:none;border-radius:999px;padding:10px 14px;font-weight:700;cursor:pointer;background:#eef0f6;color:#1f2547}
  .btn.primary{background:var(--accent);color:#fff}
  .btn.ghost{background:#f4f5fd}
  .btn.warn{background:#ffe9e9;color:#8a1c1c}
  .btn:active{transform:translateY(1px) scale(.99)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .result{min-height:3.2em;display:flex;align-items:center;justify-content:center;border:2px dashed #ddd;border-radius:10px;font-size:clamp(20px,3.5vw,28px);font-weight:700;letter-spacing:.02em;padding:16px;margin:10px 0;background:#fafafa}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#f0f1ff;color:#2a2f6a;font-weight:700;font-size:12px;margin-left:6px}
  .note{font-size:12px;color:var(--muted)}
  .section{display:none}
  .section.active{display:block}
  textarea{width:100%;min-height:96px;resize:vertical;padding:12px 14px;border:2px solid #e7e7ee;border-radius:12px;font-size:15px;outline:none}
  textarea:focus{border-color:#bcc7ff;box-shadow:0 0 0 4px rgba(91,124,250,.12)}
  input[type="text"]{padding:10px 12px;border:2px solid #e7e7ee;border-radius:10px;font-size:15px;outline:none}
  input[type="text"]:focus{border-color:#bcc7ff;box-shadow:0 0 0 4px rgba(91,124,250,.12)}
  .grid{display:grid;gap:10px}
  .card{border:1px solid #eceef7;border-radius:12px;padding:12px;background:#fff}
  .list{list-style:none;margin:0;padding:0}
  .list li{display:flex;gap:10px;align-items:center;justify-content:space-between;border-bottom:1px dashed #ececf5;padding:10px 4px}
  .list li:last-child{border-bottom:none}
  .topic-text{flex:1;min-width:0}
  .muted{color:#777;font-size:12px}
  .answers{display:grid;gap:10px}
  .ans{border:1px solid #eceef7;border-radius:10px;padding:10px}
  .ans .meta{font-size:12px;color:#777;margin-top:4px}
  .spacer{height:4px}
  .switch{display:inline-flex;gap:8px;align-items:center}
  .switch input{transform:scale(1.2)}
</style>
</head>
<body>
<div class="wrap">
  <h1>話題ランダム表示 <span id="topicCount" class="pill">—</span></h1>
  <div class="tabs">
    <button class="btn primary" data-nav="home">ホーム</button>
    <button class="btn" data-nav="topics">話題一覧</button>
    <button class="btn" data-nav="answers">過去の回答</button>
  </div>

  <!-- Home -->
  <section id="page-home" class="section active">
    <p class="note">「ランダムに表示」で話題を選び、すぐ下のフォームから回答を保存できます（重複なしモード対応）。</p>
    <div id="result" class="result" aria-live="polite" aria-atomic="true">ここに結果が表示されます</div>
    <div class="row" style="margin:6px 0 10px">
      <button id="drawBtn" class="btn primary" type="button">ランダムに表示</button>
      <button id="resetShownBtn" class="btn" type="button" title="重複なしモードの抽選プールをリセット">抽選プールをリセット</button>
      <span class="switch">
        <input id="noRepeatToggle" type="checkbox" />
        <label for="noRepeatToggle">重複しない抽選モード</label>
      </span>
      <span id="poolStatus" class="muted"></span>
    </div>

    <!-- 回答フォーム（話題のすぐ下） -->
    <div class="card grid" aria-labelledby="answerHdr">
      <div class="row" style="justify-content:space-between">
        <strong id="answerHdr">この話題への回答</strong>
        <span id="curAnsCount" class="muted"></span>
      </div>
      <textarea id="answerInput" placeholder="ここに回答を入力（Enter+Ctrl/⌘ でも保存）"></textarea>
      <div class="row">
        <button id="saveAnswerBtn" class="btn" type="button">回答を保存</button>
        <button id="showCurrentAnswersBtn" class="btn ghost" type="button">この話題の保存済みを表示</button>
        <button id="clearCurrentBtn" class="btn warn" type="button">この話題の回答をすべて削除</button>
      </div>
      <div id="currentAnswers" class="answers" style="display:none"></div>
      <span class="note">回答はブラウザの <code>localStorage</code> に保存されます。</span>
    </div>
  </section>

  <!-- Topics page -->
  <section id="page-topics" class="section">
    <div class="grid">
      <div class="row" style="justify-content:space-between">
        <strong>話題一覧と並べ替え</strong>
        <span class="note">↑↓で順序変更（保存済み）。</span>
      </div>
      <form id="addForm" class="row" autocomplete="off" onsubmit="return false;">
        <input id="topicInput" type="text" placeholder="話題を追加（例：好きな国・行ってみたい場所）" />
        <button id="addBtn" class="btn" type="submit">追加</button>
      </form>
      <ul id="topicList" class="list"></ul>
    </div>
  </section>

  <!-- Answers page -->
  <section id="page-answers" class="section">
    <div class="grid">
      <div class="row" style="justify-content:space-between">
        <strong>過去の回答一覧</strong>
        <div class="row">
          <button id="exportCsvBtn" class="btn" type="button">CSVエクスポート</button>
          <button id="clearAllBtn" class="btn warn" type="button">全回答を削除</button>
        </div>
      </div>
      <div id="answersContainer" class="grid"></div>
      <span class="note">※ 回答は話題ごとにまとまっています。各回答の「編集／削除」で個別管理できます。</span>
    </div>
  </section>
</div>

<script>
  // ====== LocalStorage Keys ======
  const LS_TOPICS = "topics_v2";
  const LS_STORE  = "qaStore_v2";
  const LS_FLAGS  = "flags_v1"; // { noRepeat:boolean, pool:number[] }

  // ====== 初期話題（ご指定＋既存3件）======
  const DEFAULT_TOPICS = [
    "好きなスポーツ","好きな食べ物","好きな飲み物",
    "相手に教えたい、一番ハマったゲームは？",
    "相手には教えられる！恋庭を始めようと思ったきっかけは？",
    "相手に、今日の出来事を伝えよう",
    "相手に伝えたい、マイブームは？",
    "今までで一番課金したゲームは?",
    "次の休日、何をして過ごす？",
    "修学旅行はどこに行った？",
    "相手になんて呼んでほしい？",
    "歴代のニックネームは？",
    "最近どこにお出かけした？",
    "よく使うSNSは？",
    "相手におすすめしたい、最近読んで面白かった漫画は？",
    "自分はどんな動物に似てると思う？",
    "実は今、○人のフレンドがいます！",
    "好きなゲームのジャンルは？",
    "一人の時間、どれくらい必要？",
    "今までで一番プレイ時間が長いゲームは？",
    "最近一番がんばったことは？",
    "相手に自慢したいポイントは？",
    "仲良くなる人の共通点は？",
    "どんな人が苦手？",
    "行きつけのお店は？",
    "友達といる時の自分のポジションは？",
    "今、欲しいものは？",
    "ちょっと聞きづらいけど、相手に聞きたいことは！？",
    "悩みを相談する方？される方？",
    "一日で最高何時間ゲームした事ある？",
    "最近買ったお気に入りの物は？",
    "相手におすすめしたい、最近観て面白かった映画は？",
    "相手におすすめしたい、最近気に入っているお笑い芸人は？",
    "眠れないときどうする？",
    "相手に伝えたい、最近うれしかった出来事は？",
    "最後の恋愛はいつ？",
    "昨日の晩御飯は何食べた？",
    "今までどんな仕事をしたことがある？",
    "あえて言うなら何オタク？",
    "人間関係でこれだけは許せないことは？",
    "一番感動したゲームは？",
    "相手にも教えたい、最近良く使っているアプリは？",
    "相手に伝えたい、最近行ったおすすめスポットは？",
    "ゲームを選ぶときに一番重視することは？",
    "いつか行ってみたい旅行先は？",
    "スマホゲーム派？家庭用ゲーム派？",
    "好きなゲームのキャラクターは？",
    "成し遂げたい将来の夢は？",
    "得意料理は？",
    "好きなファッションはどんなファッション？",
    "相手にだけは言える、自分の弱みは？",
    "恋庭で好きなブランドは？",
    "自分なりのストレス解消法は？",
    "子供のころ好きだった給食は？",
    "相手と一緒にやってみたいゲームは？",
    "生まれ変わるなら何になりたい？",
    "昔やっていた習い事は？",
    "会ってみたい有名人・偉人は誰？",
    "一番うれしかったプレゼントは？",
    "100億円あったらどうする？",
    "相手にこっそり教えたい、自分のフェチは？",
    "無人島に一つだけもっていくなら？",
    "今年のクリスマスは誰と過ごす予定？",
    "好きな遊園地は？",
    "異性の好きな仕草は？",
    "恋庭でお気に入りのピピは？",
    "喧嘩したらどうやって仲直りする？",
    "タイムトラベルするなら未来？過去？",
    "初めて購入したゲームソフトは？",
    "一万円もらえたら何に使う？",
    "田舎と都会どっちに住みたい？",
    "今一番欲しい恋庭のアイテムは？",
    "今、悩んでいることは？",
    "人生最大のピンチは？",
    "毎日欠かさずやっていることは？",
    "尊敬する人は？",
    "今まで行った中で、一番お気に入りの場所は？",
    "人間関係で気を付けていることは？",
    "恋愛で気を付けていることは？",
    "相手になら言える！どんな子供だった？",
    "地球最後の日に何をしたい？",
    "マンションと一軒家、どっちに住みたい？",
    "将来身につけたいと思っているスキルは？",
    "自分の親ってどんな親？",
    "小さい頃好きだったアニメは？",
    "異性の好きな髪型は？",
    "自分の癖は？",
    "人生で一番後悔していることは？",
    "人生で一番嬉しかったことは？",
    "ニックネームの由来は？",
    "相手と一緒にプレイして思う、恋庭にあったら嬉しい機能は？",
    "相手と一緒にプレイして思う、恋庭の改善してほしいところは？",
    "もし人生をやり直せたらどんな仕事についてみたい？",
    "自分だけのマイルールってある？",
    "将来はどこに住みたい？",
    "相手にだけ見せている自分の一面は？",
    "人生で一番大変だったことは？",
    "子供のころの夢は何だった？",
    "今、一番頑張っていることは？",
    "相手と自分との共通点は？",
    "老後、どのようにして過ごしたい？",
    "子どもにつけたい名前は？",
    "相手に感謝の気持ちを伝えよう！",
    "人生で最も大切にしていることは？",
    "2人だからこそやってみたいことは？"
  ];

  // ====== 状態 ======
  let topics = loadTopics();
  let store  = loadStore();
  let flags  = loadFlags();
  let lastIndex = -1; // 直前表示の重複回避（noRepeatオフ時）
  const state = { page: "home" };

  // ====== 要素 ======
  const el = (id)=>document.getElementById(id);
  const topicCount = el("topicCount");
  const resultEl = el("result");
  const drawBtn = el("drawBtn");
  const resetShownBtn = el("resetShownBtn");
  const noRepeatToggle = el("noRepeatToggle");
  const poolStatus = el("poolStatus");

  const answerInput = el("answerInput");
  const saveAnswerBtn = el("saveAnswerBtn");
  const showCurrentAnswersBtn = el("showCurrentAnswersBtn");
  const clearCurrentBtn = el("clearCurrentBtn");
  const currentAnswers = el("currentAnswers");
  const curAnsCount = el("curAnsCount");

  const addForm = el("addForm");
  const topicInput = el("topicInput");
  const topicList = el("topicList");

  const answersContainer = el("answersContainer");
  const exportCsvBtn = el("exportCsvBtn");
  const clearAllBtn = el("clearAllBtn");

  // ====== ユーティリティ ======
  function loadTopics(){
    const raw = localStorage.getItem(LS_TOPICS);
    if (!raw){ localStorage.setItem(LS_TOPICS, JSON.stringify(DEFAULT_TOPICS)); return [...DEFAULT_TOPICS];}
    try{ const arr = JSON.parse(raw); return Array.isArray(arr)&&arr.length?arr:[...DEFAULT_TOPICS]; }catch{ return [...DEFAULT_TOPICS];}
  }
  function saveTopics(){ localStorage.setItem(LS_TOPICS, JSON.stringify(topics)); }

  function loadStore(){ try{ return JSON.parse(localStorage.getItem(LS_STORE) || "{}"); }catch{ return {}; } }
  function saveStore(){ localStorage.setItem(LS_STORE, JSON.stringify(store)); }

  function loadFlags(){
    try{
      const f = JSON.parse(localStorage.getItem(LS_FLAGS) || "{}");
      return { noRepeat: !!f.noRepeat, pool: Array.isArray(f.pool)?f.pool:[] };
    }catch{ return { noRepeat:false, pool:[] }; }
  }
  function saveFlags(){ localStorage.setItem(LS_FLAGS, JSON.stringify(flags)); }

  const pad = n=>String(n).padStart(2,"0");
  const fmt = (ts)=>{ const d=new Date(ts); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`; };
  const escapeHtml = s=>s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  const normalize = s=>s.replace(/\s+/g," ").replace(/[　]/g," ").trim().toLowerCase();

  // ====== 画面遷移 ======
  document.querySelectorAll("[data-nav]").forEach(b=>{
    b.addEventListener("click", ()=>navigate(b.getAttribute("data-nav")));
  });
  function navigate(page){
    state.page = page;
    document.querySelectorAll(".section").forEach(s=>s.classList.remove("active"));
    el(`page-${page}`).classList.add("active");
    document.querySelectorAll("[data-nav]").forEach(b=>{
      b.classList.toggle("primary", b.getAttribute("data-nav")===page);
    });
    if (page==="topics") renderTopics();
    if (page==="answers") renderAllAnswers();
  }

  // ====== 抽選プール管理（重複なし） ======
  function buildPool(){ // 0..n-1 をシャッフル
    const arr = topics.map((_,i)=>i);
    for (let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; }
    flags.pool = arr; saveFlags(); updatePoolStatus();
  }
  function drawIndex(){
    if (flags.noRepeat){
      if (!flags.pool || flags.pool.length===0) buildPool();
      return flags.pool.shift();
    }else{
      if (topics.length===1) return 0;
      let idx; do{ idx=Math.floor(Math.random()*topics.length);}while(idx===lastIndex);
      lastIndex = idx; return idx;
    }
  }
  function updatePoolStatus(){
    poolStatus.textContent = flags.noRepeat ? `（残り ${flags.pool?.length ?? 0} / ${topics.length}）` : "";
  }

  // ====== 表示中の話題 ======
  function getCurrentTopic(){
    const t = resultEl.textContent.trim();
    if (!t || t==="ここに結果が表示されます") return null;
    return t;
  }
  function updateCurAnsCount(){
    const t = getCurrentTopic(); const n = t ? (store[t]?.length||0) : 0;
    curAnsCount.textContent = t ? `保存済み：${n}件` : "";
  }

  // ====== ホーム：抽選 & 回答フォーム ======
  function drawRandomTopic(){
    if (topics.length===0){ resultEl.textContent="話題がありません。『話題一覧』で追加してください。"; return; }
    const idx = drawIndex();
    const text = topics[idx];
    resultEl.textContent = text;
    updateCurAnsCount();
    currentAnswers.style.display="none";
    currentAnswers.innerHTML="";
    saveFlags(); // pool更新反映
  }

  function resetShownPool(){
    if (!flags.noRepeat){ alert("重複なしモードがオフです。まずオンにしてください。"); return; }
    buildPool();
    alert("抽選プールをリセットしました。");
  }

  function saveAnswer(){
    const topic = getCurrentTopic();
    if (!topic){ alert("まず話題を表示してください。"); return; }
    const text = answerInput.value.trim();
    if (!text){ alert("回答が空です。"); return; }
    if (!store[topic]) store[topic] = [];
    store[topic].push({ text, ts: Date.now() });
    saveStore();
    answerInput.value="";
    updateCurAnsCount();
    // 直近を展開
    showCurrentAnswers();
  }

  function showCurrentAnswers(){
    const topic = getCurrentTopic();
    if (!topic){ alert("まず話題を表示してください。"); return; }
    const items = store[topic]||[];
    currentAnswers.style.display="grid";
    currentAnswers.innerHTML = items.length ? items.map((a,i)=>renderAnswerItem(topic,i,a,true)).join("") :
      `<div class="muted">この話題の保存済み回答はまだありません。</div>`;
    bindAnswerItemEvents(currentAnswers, topic);
  }

  function clearCurrentAnswers(){
    const topic = getCurrentTopic();
    if (!topic){ alert("まず話題を表示してください。"); return; }
    const n = (store[topic]?.length||0);
    if (!n){ alert("削除する回答がありません。"); return; }
    if (!confirm(`「${topic}」の回答 ${n}件を削除します。よろしいですか？`)) return;
    delete store[topic]; saveStore(); updateCurAnsCount();
    currentAnswers.innerHTML = `<div class="muted">この話題の保存済み回答はまだありません。</div>`;
  }

  // ====== 話題：表示・追加・並べ替え ======
  function renderTopics(){
    topicCount.textContent = `${topics.length}件`;
    topicList.innerHTML = topics.map((t,i)=>`
      <li>
        <div class="topic-text">${escapeHtml(t)}</div>
        <div class="row">
          <button class="btn" data-up="${i}" ${i===0?"disabled":""}>↑</button>
          <button class="btn" data-down="${i}" ${i===topics.length-1?"disabled":""}>↓</button>
        </div>
      </li>
    `).join("");
    topicList.querySelectorAll("[data-up]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const i = +b.getAttribute("data-up");
        if (i>0){ [topics[i-1],topics[i]]=[topics[i],topics[i-1]]; saveTopics(); renderTopics(); rebuildPoolIfNeeded(); }
      });
    });
    topicList.querySelectorAll("[data-down]").forEach(b=>{
      b.addEventListener("click", ()=>{
        const i = +b.getAttribute("data-down");
        if (i<topics.length-1){ [topics[i+1],topics[i]]=[topics[i],topics[i+1]]; saveTopics(); renderTopics(); rebuildPoolIfNeeded(); }
      });
    });
  }

  function rebuildPoolIfNeeded(){
    if (flags.noRepeat){ buildPool(); }
    updatePoolStatus();
  }

  addForm?.addEventListener("submit",(e)=>{
    e.preventDefault();
    const v = (topicInput.value||"").trim();
    if (!v) return alert("空欄は追加できません。");
    const norm = normalize(v);
    if (topics.some(t=>normalize(t)===norm)) return alert("同じ話題が既にあります。");
    topics.push(v); saveTopics(); renderTopics(); rebuildPoolIfNeeded();
    topicInput.value=""; topicCount.textContent = `${topics.length}件`;
  });

  // ====== 回答ページ：一覧／編集／削除／CSV ======
  function renderAllAnswers(){
    // topics の順で出す
    answersContainer.innerHTML = topics.map(tp=>{
      const arr = store[tp]||[];
      const blocks = arr.length ? arr.map((a,i)=>renderAnswerItem(tp,i,a)).join("") :
        `<div class="muted">保存なし</div>`;
      return `
        <div class="card">
          <div class="row" style="justify-content:space-between">
            <strong>${escapeHtml(tp)}</strong>
            <span class="muted">件数：${arr.length}</span>
          </div>
          <div class="spacer"></div>
          <div class="answers" data-topic="${escapeHtml(tp)}">
            ${blocks}
          </div>
        </div>`;
    }).join("");
    // それぞれのコンテナにイベントバインド
    answersContainer.querySelectorAll(".answers").forEach(box=>{
      const tp = box.getAttribute("data-topic");
      bindAnswerItemEvents(box, tp);
    });
  }

  function renderAnswerItem(topic, idx, a, current=false){
    const id = `${topic}__${idx}__${current?"cur":"all"}`;
    return `
      <div class="ans" data-idx="${idx}">
        <div class="view" id="view-${id}">
          <div>${escapeHtml(a.text).replace(/\n/g,"<br>")}</div>
          <div class="meta">#${idx+1}・保存日時：${fmt(a.ts)}</div>
          <div class="row" style="margin-top:6px">
            <button class="btn ghost" data-edit="${idx}">編集</button>
            <button class="btn warn" data-del="${idx}">削除</button>
          </div>
        </div>
        <div class="edit" id="edit-${id}" style="display:none">
          <textarea>${escapeHtml(a.text)}</textarea>
          <div class="row" style="margin-top:6px">
            <button class="btn" data-save="${idx}">保存</button>
            <button class="btn ghost" data-cancel="${idx}">キャンセル</button>
          </div>
        </div>
      </div>`;
  }

  function bindAnswerItemEvents(container, topic){
    container.querySelectorAll("[data-edit]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = +btn.getAttribute("data-edit");
        toggleEdit(container, topic, i, true);
      });
    });
    container.querySelectorAll("[data-cancel]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = +btn.getAttribute("data-cancel");
        toggleEdit(container, topic, i, false);
      });
    });
    container.querySelectorAll("[data-save]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = +btn.getAttribute("data-save");
        const card = btn.closest(".ans");
        const ta = card.querySelector("textarea");
        const val = ta.value.trim();
        if (!val) return alert("空の回答は保存できません。");
        if (!store[topic]) store[topic] = [];
        store[topic][i].text = val;
        saveStore();
        // 再描画（該当カードだけ更新）
        const a = store[topic][i];
        card.outerHTML = renderAnswerItem(topic, i, a, container.id==="currentAnswers");
        // 再バインド（そのコンテナのみ）
        bindAnswerItemEvents(container, topic);
        updateCurAnsCount();
      });
    });
    container.querySelectorAll("[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const i = +btn.getAttribute("data-del");
        if (!confirm("この回答を削除します。よろしいですか？")) return;
        if (!store[topic]) return;
        store[topic].splice(i,1);
        if (store[topic].length===0) delete store[topic];
        saveStore();
        // 親画面の種類に応じて再描画
        if (container.id==="currentAnswers"){
          showCurrentAnswers();
          updateCurAnsCount();
        }else{
          renderAllAnswers();
        }
      });
    });
  }

  function toggleEdit(container, topic, idx, on){
    const cur = container.id==="currentAnswers";
    const id = `${topic}__${idx}__${cur?"cur":"all"}`;
    el(`view-${id}`).style.display = on?"none":"block";
    el(`edit-${id}`).style.display = on?"block":"none";
  }

  function exportCsv(){
    // rows: header + each answer
    const rows = [["topic","text","timestamp"]];
    topics.forEach(tp=>{
      (store[tp]||[]).forEach(a=>{
        rows.push([tp, a.text.replace(/\r?\n/g,"\\n"), new Date(a.ts).toISOString()]);
      });
    });
    const csv = rows.map(r=>r.map(field=>{
      // CSVエスケープ（ダブルクオートで囲み、内部の"は""に）
      const s = String(field).replace(/"/g,'""');
      return `"${s}"`;
    }).join(",")).join("\r\n");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8;"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = `answers_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.csv`;
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  function clearAllAnswers(){
    const total = Object.values(store).reduce((acc,arr)=>acc+(arr?.length||0),0);
    if (!total) return alert("削除する回答がありません。");
    if (!confirm(`全回答 ${total}件を削除します。よろしいですか？`)) return;
    store = {}; saveStore();
    renderAllAnswers(); updateCurAnsCount(); currentAnswers.style.display="none";
  }

  // ====== 初期化 ======
  function init(){
    topicCount.textContent = `${topics.length}件`;
    noRepeatToggle.checked = !!flags.noRepeat;
    updatePoolStatus();
    noRepeatToggle.addEventListener("change", ()=>{
      flags.noRepeat = noRepeatToggle.checked;
      if (flags.noRepeat) buildPool(); else { flags.pool = []; saveFlags(); }
      updatePoolStatus();
    });
    drawBtn.addEventListener("click", drawRandomTopic);
    resetShownBtn.addEventListener("click", resetShownPool);
    saveAnswerBtn.addEventListener("click", saveAnswer);
    showCurrentAnswersBtn.addEventListener("click", showCurrentAnswers);
    clearCurrentBtn.addEventListener("click", clearCurrentAnswers);
    exportCsvBtn.addEventListener("click", exportCsv);
    clearAllBtn.addEventListener("click", clearAllAnswers);
    // Ctrl/⌘+Enter 保存
    answerInput.addEventListener("keydown",(e)=>{
      if ((e.ctrlKey||e.metaKey) && e.key==="Enter"){ e.preventDefault(); saveAnswer(); }
    });
    // 最初の描画
    renderTopics();
  }
  init();
</script>
</body>
</html>